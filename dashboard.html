<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Claremont School - Finance Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#2C3E75", // Deep blue from the screenshot concept
                        secondary: "#FBBF24", // Accent yellow/gold often seen in school crests or alerts
                        success: "#10B981",
                        danger: "#EF4444",
                        "background-light": "#F3F4F6",
                        "background-dark": "#111827",
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#1F2937",
                        "border-light": "#E5E7EB",
                        "border-dark": "#374151",
                        "text-light": "#1F2937",
                        "text-dark": "#F9FAFB",
                        "text-muted-light": "#6B7280",
                        "text-muted-dark": "#9CA3AF",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.5rem",
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #4B5563;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark transition-colors duration-200 min-h-screen">
    <nav
        class="bg-surface-light dark:bg-surface-dark border-b border-border-light dark:border-border-dark sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="text-primary font-bold text-xl tracking-wide dark:text-blue-400">CLAREMONT
                            SCHOOL</span>
                        <span
                            class="ml-2 text-text-muted-light dark:text-text-muted-dark text-sm border-l border-border-light dark:border-border-dark pl-2">Purchasing
                            Portal</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button id="settings-btn"
                            class="p-2 rounded-full text-text-muted-light dark:text-text-muted-dark hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none">
                            <span class="material-icons">settings</span>
                        </button>
                        <div id="settings-menu"
                            class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg py-1 bg-white dark:bg-surface-dark ring-1 ring-black ring-opacity-5 hidden z-50"
                            role="menu" aria-orientation="vertical">
                            <a href="<?= appUrl ?>"
                                class="block px-4 py-2 text-sm text-text-light dark:text-text-dark hover:bg-gray-100 dark:hover:bg-gray-700"
                                role="menuitem">
                                <span class="flex items-center"><span
                                        class="material-icons text-sm mr-2">arrow_back</span>
                                    Return to Portal</span>
                            </a>
                            <button onclick="toggleTheme()"
                                class="w-full text-left block px-4 py-2 text-sm text-text-light dark:text-text-dark hover:bg-gray-100 dark:hover:bg-gray-700"
                                role="menuitem">
                                <span class="flex items-center"><span
                                        class="material-icons text-sm mr-2">brightness_6</span>
                                    Toggle Theme</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="h-1 bg-yellow-400 w-full"></div>
    </nav>
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="md:flex md:items-center md:justify-between mb-8">
            <div>
                <h1 class="text-2xl font-bold text-text-light dark:text-text-dark leading-7 sm:truncate">Finance
                    Dashboard</h1>
                <p class="mt-1 text-sm text-text-muted-light dark:text-text-muted-dark">Overview of budget allocation
                    and expenditure.</p>
            </div>
            <div class="mt-4 flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3">
                <div class="relative rounded-md shadow-sm">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="material-icons text-gray-400 text-sm">filter_list</span>
                    </div>
                    <select id="dept-filter"
                        class="focus:ring-primary focus:border-primary block w-full pl-10 sm:text-sm border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-surface-dark text-text-light dark:text-text-dark py-2">
                        <option value="All">All Departments</option>
                    </select>
                </div>
                <div class="flex items-center justify-end">
                    <button id="export-btn"
                        class="bg-white dark:bg-surface-dark text-text-light dark:text-text-dark border border-gray-300 dark:border-gray-600 rounded-md px-4 py-2 text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary shadow-sm flex items-center">
                        <span class="material-icons text-sm mr-2">download</span> Export Report
                    </button>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
            <div
                class="bg-surface-light dark:bg-surface-dark overflow-hidden shadow rounded-lg border border-border-light dark:border-border-dark">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-blue-100 dark:bg-blue-900 rounded-md p-3">
                            <span class="material-icons text-primary dark:text-blue-300">account_balance_wallet</span>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt
                                    class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark truncate">
                                    Total Budget</dt>
                                <dd>
                                    <p class="mt-2 flex items-baseline gap-2">
                                        <span class="text-3xl font-bold text-text-light dark:text-text-dark"
                                            id="total-budget">£0.00</span>
                                    </p>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div
                class="bg-surface-light dark:bg-surface-dark overflow-hidden shadow rounded-lg border border-border-light dark:border-border-dark">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-indigo-100 dark:bg-indigo-900 rounded-md p-3">
                            <span class="material-icons text-indigo-600 dark:text-indigo-300">shopping_cart</span>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt
                                    class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark truncate">
                                    Total Spent</dt>
                                <dd>
                                    <div id="total-spent" class="text-lg font-bold text-text-light dark:text-text-dark">
                                        Loading...</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-800 px-5 py-3">
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div id="spend-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="spend-text" class="text-xs text-text-muted-light dark:text-text-muted-dark mt-2">
                        Calculating...</p>
                </div>
            </div>
            <div
                class="bg-surface-light dark:bg-surface-dark overflow-hidden shadow rounded-lg border border-border-light dark:border-border-dark">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-green-100 dark:bg-green-900 rounded-md p-3">
                            <span class="material-icons text-green-600 dark:text-green-300">savings</span>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt
                                    class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark truncate">
                                    Remaining Balance</dt>
                                <dd>
                                    <div id="remaining-balance"
                                        class="text-lg font-bold text-text-light dark:text-text-dark">Loading...</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-800 px-5 py-3">
                    <div class="text-sm text-text-muted-light dark:text-text-muted-dark">
                        Healthy status
                    </div>
                </div>
            </div>
            <div
                class="bg-surface-light dark:bg-surface-dark overflow-hidden shadow rounded-lg border border-border-light dark:border-border-dark">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-yellow-100 dark:bg-yellow-900 rounded-md p-3">
                            <span class="material-icons text-yellow-600 dark:text-yellow-300">pending_actions</span>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt
                                    class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark truncate">
                                    Pending Requests</dt>
                                <dd>
                                    <div id="pending-count"
                                        class="text-lg font-bold text-text-light dark:text-text-dark">...</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-800 px-5 py-3">
                    <div class="text-sm text-yellow-600 dark:text-yellow-400 flex items-center">
                        <span class="material-icons text-sm mr-1">warning</span>
                        <span id="pending-subtext">...</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Analysis Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Monthly Spending Chart -->
            <div
                class="lg:col-span-2 bg-surface-light dark:bg-surface-dark shadow rounded-lg p-6 border border-border-light dark:border-border-dark">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-text-light dark:text-text-dark">Monthly Spending
                        Overview</h3>
                    <div class="flex items-center space-x-2">
                        <span
                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">Monthly
                            View</span>
                    </div>
                </div>
                <div class="relative h-60 w-full">
                    <canvas id="budgetChart"></canvas>
                </div>
            </div>

            <!-- Dept Chart -->
            <div
                class="bg-surface-light dark:bg-surface-dark shadow rounded-lg p-6 border border-border-light dark:border-border-dark flex flex-col justify-center">
                <h3 class="text-lg leading-6 font-medium text-text-light dark:text-text-dark mb-4">Spending by
                    Department</h3>
                <div class="relative h-48 w-full flex justify-center">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Details Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Recent Transactions -->
            <div
                class="lg:col-span-2 bg-surface-light dark:bg-surface-dark shadow rounded-lg border border-border-light dark:border-border-dark overflow-hidden">
                <div
                    class="px-6 py-4 border-b border-border-light dark:border-border-dark flex justify-between items-center">
                    <h3 class="text-lg leading-6 font-medium text-text-light dark:text-text-dark">Recent Large
                        Transactions
                        (>£500)</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 table-fixed">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th scope="col"
                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                    Date</th>
                                <th scope="col"
                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                    Department</th>
                                <th scope="col"
                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-auto">
                                    Description</th>
                                <th scope="col"
                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                    Supplier</th>
                                <th scope="col"
                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                    Amount</th>
                                <th scope="col"
                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                    Status</th>
                            </tr>
                        </thead>
                        <tbody id="tx-table-body"
                            class="bg-surface-light dark:bg-surface-dark divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Transactions will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Suppliers (Moved Here) -->
            <div
                class="bg-surface-light dark:bg-surface-dark shadow rounded-lg p-6 border border-border-light dark:border-border-dark h-full">
                <h3 class="text-lg leading-6 font-medium text-text-light dark:text-text-dark mb-4">Top 5 Suppliers
                </h3>
                <ul id="top-suppliers-list" class="divide-y divide-gray-200 dark:divide-gray-700">
                    <!-- Top suppliers will be injected here -->
                </ul>
            </div>
        </div>
    </main>
    <script>
        // --- GLOBAL STATE ---
        let budgetChart, departmentChart;
        let globalData = null; // Store fetched data for filtering

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initCharts(); // Init empty charts first
            fetchDashboardData();

            // Settings Dropdown Logic
            const settingsBtn = document.getElementById('settings-btn');
            const settingsMenu = document.getElementById('settings-menu');

            settingsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                settingsMenu.classList.toggle('hidden');
            });

            document.addEventListener('click', () => {
                settingsMenu.classList.add('hidden');
            });

            // Filter Logic
            document.getElementById('dept-filter').addEventListener('change', (e) => {
                if (globalData) renderDashboard(JSON.stringify(globalData), e.target.value);
            });

            // Export Logic
            document.getElementById('export-btn').addEventListener('click', () => {
                exportReport();
            });
        });

        function exportReport() {
            if (!globalData || !globalData.orders) return;

            // Get current view data (respecting filters if any, or just dump all?)
            // User asked "export data from the current view". 
            // We can check the dropdown value.
            const deptFilter = document.getElementById('dept-filter').value;
            let ordersToExport = globalData.orders;
            if (deptFilter !== 'All') {
                ordersToExport = ordersToExport.filter(o => o.dept === deptFilter);
            }

            // CSV Header
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,Dept,Date,Requester,Supplier,Description,Code,Qty,Total,Status\n";

            // CSV Rows
            ordersToExport.forEach(row => {
                const clean = (text) => `"${String(text).replace(/"/g, '""')}"`;
                const line = [
                    clean(row.id), clean(row.dept), clean(row.dateReq), clean(row.requester),
                    clean(row.supplier), clean(row.desc), clean(row.code), clean(row.qty),
                    clean(row.totalPrice), clean(row.status)
                ].join(",");
                csvContent += line + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `finance_report_${deptFilter}_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function fetchDashboardData() {
            // Show loading states? (Already static "Loading...")
            google.script.run
                .withSuccessHandler(response => {
                    globalData = JSON.parse(response); // Store globally
                    initDeptFilter(globalData); // Populate dropdown
                    renderDashboard(response, 'All'); // Render All initially
                })
                .withFailureHandler(error => {
                    console.error("Dashboard Load Error", error);
                    alert("Failed to load dashboard data.");
                })
                .getDashboardData();
        }

        function initDeptFilter(data) {
            const filterEl = document.getElementById('dept-filter');
            // Extract distinct departments from orders or budgets
            // Using budgets keys is safer for "Expected" departments, but orders might have ad-hoc ones.
            // Let's combine both.
            const budgetDepts = Object.keys(data.budgets || {});
            const orderDepts = [...new Set(data.orders.map(o => o.dept))];
            const allDepts = [...new Set([...budgetDepts, ...orderDepts])].sort();

            allDepts.forEach(dept => {
                if (!dept) return;
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                filterEl.appendChild(option);
            });
        }

        function renderDashboard(response, filterDept = 'All') {
            const data = typeof response === 'string' ? JSON.parse(response) : response;
            if (!data.success) {
                console.error("Server Error:", data.error);
                return;
            }

            // Apply Filtering
            const filteredBudgets = {};
            let filteredOrders = data.orders;

            if (filterDept !== 'All') {
                // 1. Filter Budgets
                if (data.budgets[filterDept]) {
                    filteredBudgets[filterDept] = data.budgets[filterDept];
                }
                // 2. Filter Orders
                filteredOrders = data.orders.filter(o => o.dept === filterDept);
            } else {
                Object.assign(filteredBudgets, data.budgets);
            }

            // Create a filtered data view object to pass down
            const viewData = {
                budgets: filteredBudgets,
                orders: filteredOrders
            };

            updateCards(viewData);
            updateChartsWithData(viewData);
            updateTopSuppliers(viewData.orders);
            updateRecentTransactions(viewData.orders);
        }

        // --- CARDS ---
        function updateCards(data) {
            const budgets = data.budgets;

            // Configurable: If budgets are per-dept, we sum them up for "Total"
            // Or if there's a master budget entry. Assuming sum of all depts for now.
            let totalBudget = 0;
            let totalSpent = 0;
            let totalRemaining = 0;

            // Sum up from the budgets object
            Object.values(budgets).forEach(b => {
                totalBudget += b.total;
                totalSpent += b.spent;
                totalRemaining += b.remaining;
            });

            // 1. Total Budget
            document.getElementById('total-budget').textContent = formatCurrency(totalBudget);

            // 2. Total Spent
            document.getElementById('total-spent').textContent = formatCurrency(totalSpent);

            // 3. Spend Bar & %
            const percentUsed = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0;
            document.getElementById('spend-bar').style.width = `${Math.min(percentUsed, 100)}%`;
            document.getElementById('spend-text').textContent = `${Math.round(percentUsed)}% of budget utilized`;

            // Color code the bar (green < 75, yellow < 90, red > 90)
            const barEl = document.getElementById('spend-bar');
            barEl.className = `h-2.5 rounded-full ${percentUsed > 90 ? 'bg-red-600' : percentUsed > 75 ? 'bg-yellow-500' : 'bg-indigo-600'}`;

            // 4. Remaining
            document.getElementById('remaining-balance').textContent = formatCurrency(totalRemaining);

            // 5. Pending Status
            const pendingOrders = data.orders.filter(o => o.status === 'Pending');
            document.getElementById('pending-count').textContent = pendingOrders.length;

            const subtextEl = document.getElementById('pending-subtext');
            if (pendingOrders.length > 0) {
                subtextEl.textContent = `${pendingOrders.length} require immediate approval`;
                subtextEl.parentElement.classList.remove('hidden');
            } else {
                subtextEl.textContent = "No urgent actions";
                // Optional: Hide the warning icon/text if 0?
                // subtextEl.parentElement.classList.add('hidden');
            }
        }

        // --- CHARTS ---
        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
            };

            // Budget Chart (Bar)
            const ctxBudget = document.getElementById('budgetChart').getContext('2d');
            budgetChart = new Chart(ctxBudget, {
                type: 'bar',
                data: {
                    labels: ['Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'],
                    datasets: [
                        {
                            label: 'Actual Spend',
                            data: [],
                            backgroundColor: 'rgba(44, 62, 117, 0.9)',
                            borderColor: '#2C3E75',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        legend: { display: false } // Hide legend if only one dataset? Or keep it?
                        // User said "Chart should just show budget spends". Let's removing legend or keep it simple.
                        // I'll keep the legend as it's good practice, but since it's just one, maybe not needed.
                        // Actually, I'll keep it for clarity "Actual Spend".
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { display: true, drawBorder: false } }, // Removed ticks logic for simplicity
                        x: { grid: { display: false } }
                    }
                }
            });

            // Department Chart (Doughnut)
            const ctxDept = document.getElementById('departmentChart').getContext('2d');
            departmentChart = new Chart(ctxDept, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Spend by Dept',
                        data: [],
                        backgroundColor: [
                            '#2C3E75', '#10B981', '#FBBF24', '#EF4444', '#6B7280', '#8B5CF6', '#EC4899'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { boxWidth: 12, font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function updateChartsWithData(data) {
            // --- 1. Budget Chart Logic (Aggregated by Month) ---
            // Initialize 12 buckets for Sep -> Aug
            const monthNames = ['Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'];
            const monthMap = { 8: 0, 9: 1, 10: 2, 11: 3, 0: 4, 1: 5, 2: 6, 3: 7, 4: 8, 5: 9, 6: 10, 7: 11 }; // Month Index -> Array Index (Sep=0)

            const monthlySpend = new Array(12).fill(0);

            data.orders.forEach(order => {
                // "Ordered" status or valid price implies spent
                if (order.status === 'Ordered') {
                    const dateParts = order.dateOrdered ? order.dateOrdered.split('/') : order.dateReq.split('/'); // dd/mm/yyyy
                    if (dateParts.length === 3) {
                        const monthIndex = parseInt(dateParts[1], 10) - 1; // 0-11
                        const mappedIndex = monthMap[monthIndex];
                        if (mappedIndex !== undefined) {
                            // Clean price string "£1,200.00" -> 1200.00
                            const price = typeof order.finalPrice === 'number' ? order.finalPrice : parseFloat(order.finalPrice.toString().replace(/[^\d.-]/g, '')) || 0;
                            monthlySpend[mappedIndex] += price;
                        }
                    }
                }
            });

            // Update Chart
            budgetChart.data.datasets[0].data = monthlySpend; // Only one dataset now
            budgetChart.update();


            // --- 2. Dept Chart Logic ---
            const deptMap = {};
            data.orders.forEach(order => {
                if (order.status === 'Ordered') {
                    const price = typeof order.finalPrice === 'number' ? order.finalPrice : parseFloat(order.finalPrice.toString().replace(/[^\d.-]/g, '')) || 0;
                    deptMap[order.dept] = (deptMap[order.dept] || 0) + price;
                }
            });

            departmentChart.data.labels = Object.keys(deptMap);
            departmentChart.data.datasets[0].data = Object.values(deptMap);
            departmentChart.update();

            // Re-apply theme colors if needed (handled by initTheme mostly)
            const isDark = document.documentElement.classList.contains('dark');
            updateChartsDarkMode(isDark);
        }


        // --- LISTS ---
        function updateTopSuppliers(orders) {
            const supplierMap = {};
            orders.forEach(order => {
                if (order.status === 'Ordered') {
                    const price = typeof order.finalPrice === 'number' ? order.finalPrice : parseFloat(order.finalPrice.toString().replace(/[^\d.-]/g, '')) || 0;
                    const name = order.supplier || "Unknown";
                    supplierMap[name] = (supplierMap[name] || 0) + price;
                }
            });

            // Convert to array, sort desc, take top 5
            const sortedSuppliers = Object.entries(supplierMap)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            const listContainer = document.getElementById('top-suppliers-list');
            listContainer.innerHTML = '';

            sortedSuppliers.forEach(([name, total]) => {
                // Initials
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

                const html = `
            <li class="py-3 flex justify-between items-center">
                <div class="flex items-center">
                    <span class="h-8 w-8 rounded bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-xs font-bold text-gray-500">${initials}</span>
                    <span class="ml-3 text-sm font-medium text-text-light dark:text-text-dark truncate max-w-[150px]" title="${name}">${name}</span>
                </div>
                <span class="text-sm font-bold text-text-light dark:text-text-dark">${formatCurrencyShort(total)}</span>
            </li>
            `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        function updateRecentTransactions(orders) {
            const tbody = document.getElementById('tx-table-body');
            tbody.innerHTML = '';

            // Filter: No Pending, Amount >= 500, Top 5
            const largeOrders = orders
                .filter(o => o.status !== 'Pending' && parseFloat(o.totalPrice) >= 500)
                .slice(0, 5);

            if (largeOrders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No large transactions found.</td></tr>`;
                return;
            }

            largeOrders.forEach(order => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors border-b border-gray-200 dark:border-gray-700 last:border-0';

                const statusColor = order.status === 'Ordered' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' :
                    order.status === 'Pending' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' :
                        'bg-gray-100 text-gray-800';

                tr.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-xs text-text-light dark:text-text-dark">${order.dateReq}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-xs">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 truncate max-w-[110px]" title="${order.dept}">
                           ${order.dept}
                        </span>
                    </td>
                    <td class="px-3 py-2 text-xs text-text-light dark:text-text-dark truncate" title="${order.desc}">${order.desc}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-xs text-text-light dark:text-text-dark font-medium truncate" title="${order.supplier}">${order.supplier}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-xs font-bold text-text-light dark:text-text-dark">${formatCurrency(order.totalPrice)}</td>
                    <td class="px-3 py-2 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                            ${order.status}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- HELPERS ---
        function formatCurrency(num) {
            return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(num);
        }

        function formatCurrencyShort(num) {
            if (num >= 1000) {
                return '£' + (num / 1000).toFixed(1) + 'k';
            }
            return '£' + num;
        }

        // --- THEME LOGIC ---
        function applyTheme(isDark) {
            const themeIcon = document.querySelector('#settings-menu .material-icons.text-sm.mr-2:last-child') || { textContent: '' };
            // The icon is inside the button created in HTML. 
            // Actually, we should just swap the icon text if we want, OR just rely on CSS.
            // The toggle button text says "Toggle Theme" static.
            // Maybe we change the icon?
            // Let's just handle class and localStorage.

            if (isDark) {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            }
            updateChartsDarkMode(isDark);
        }

        function initTheme() {
            // Check local storage or system preference
            const isDark = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            applyTheme(isDark);
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            applyTheme(!isDark);
        }

        function updateChartsDarkMode(isDark) {
            const textColor = isDark ? '#F9FAFB' : '#1F2937';
            const gridColor = isDark ? '#374151' : '#E5E7EB';

            if (budgetChart) {
                budgetChart.options.scales.x.ticks.color = textColor;
                budgetChart.options.scales.y.ticks.color = textColor;
                budgetChart.options.scales.y.grid.color = gridColor;
                budgetChart.options.plugins.legend.labels.color = textColor;
                budgetChart.update();
            }

            if (departmentChart) {
                departmentChart.options.plugins.legend.labels.color = textColor;
                departmentChart.update();
            }
        }
    </script>

</body>

</html>